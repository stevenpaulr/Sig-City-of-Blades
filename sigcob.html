<!--	const translation = locals.translation, -->
<!--		playbooks = Object.keys(locals.data.playbooks);-->
<div class="sheet-wrapper">
  <input class="sheettype" type="hidden" name="attr_sheettype" value="0"/>
  <div class="type-selector flex-wrap">
    <div class="col100">
      <h1 data-i18n="choosesheetcopy"></h1>
    </div>
    <div class="col100">
      <select name="attr_freebooterorfaction">
        <optgroup>
          <option>Freebooter or Faction</option>
          <option>Freebooter Sheet</option>
          <option>Faction Sheet</option>
        </optgroup>
      </select>
    </div>
  </div>
  <div class="freebootersheet flex-wrap">
    <!--Left Column-->
    <div class="col30 generalinfo">
      <div class="label title" data-i18n="freebooter"></div>
      <input type="text" spellcheck="false" name="attr_freebooter_name" placeholder="Enter your Name and Title"/>
      <div class="label title" data-i18n="alignment"></div>
      <input type="text" spellcheck="false" name="attr_alignment" placeholder="Enter your Alignment"/>
      <div class="label title" data-i18n="relationships"></div>
      <textarea spellcheck="false" name="attr_relationships" placeholder="Enter your Relationships"></textarea>
    </div>
    <!--Middle Column-->
    <div class="col40 tracks flex-wrap">
      <div class="col50">
        <div class="label title stresslabel" data-i18n="stress"></div>
      </div>
      <div class="col50">
        <div class="label title harmlabel" data-i18n="harm"></div>
      </div>
      <div class="trackholder">
        <div class="lefttrack">
          <div class="label" data-i18n="relaxed"></div>
          <div class="sublabel" data-i18n="+minor"></div>
        </div>
        <div class="centertrack">
          <div class="centertrackrow">
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_stress1" value="1"/><span class="hexbox"></span>
            </div>
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_harm1" value="1"/><span class="hexbox"></span>
            </div>
          </div>
          <div class="centertrackrow">
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_stress2" value="1"/><span class="hexbox"></span>
            </div>
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_harm2" value="1"/><span class="hexbox"></span>
            </div>
          </div>
        </div>
        <div class="righttrack"> 
          <div class="label" data-i18n="healthy"></div>
          <div class="sublabel" data-i18n="nopenalty"></div>
        </div>
      </div>
      <div class="trackspacer"></div>
      <div class="trackholder">
        <div class="lefttrack">
          <div class="label" data-i18n="tense"></div>
          <div class="sublabel" data-i18n="+moderate"></div>
        </div>
        <div class="centertrack">
          <div class="centertrackrow">
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_stress3" value="1"/><span class="hexbox"></span>
            </div>
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_harm3" value="1"/><span class="hexbox"></span>
            </div>
          </div>
          <div class="centertrackrow">
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_stress4" value="1"/><span class="hexbox"></span>
            </div>
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_harm4" value="1"/><span class="hexbox"></span>
            </div>
          </div>
          <div class="centertrackrow">
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_stress5" value="1"/><span class="hexbox"></span>
            </div>
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_harm5" value="1"/><span class="hexbox"></span>
            </div>
          </div>
        </div>
        <div class="righttrack"> 
          <div class="label" data-i18n="wounded"></div>
          <div class="sublabel" data-i18n="reducedeffect"></div>
        </div>
      </div>
      <div class="trackspacer"></div>
      <div class="trackholder">
        <div class="lefttrack">
          <div class="label" data-i18n="overloaded"></div>
          <div class="sublabel" data-i18n="+major"></div>
        </div>
        <div class="centertrack">
          <div class="centertrackrow">
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_stress6" value="1"/><span class="hexbox"></span>
            </div>
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_harm6" value="1"/><span class="hexbox"></span>
            </div>
          </div>
          <div class="centertrackrow">
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_stress7" value="1"/><span class="hexbox"></span>
            </div>
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_harm7" value="1"/><span class="hexbox"></span>
            </div>
          </div>
          <div class="centertrackrow">
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_stress8" value="1"/><span class="hexbox"></span>
            </div>
            <div class="hexboxcontainer">
              <input class="hexbox" type="checkbox" name="attr_harm8" value="1"/><span class="hexbox"></span>
            </div>
          </div>
        </div>
        <div class="righttrack"> 
          <div class="label" data-i18n="incapacitated"></div>
          <div class="sublabel" data-i18n="noactions"></div>
        </div>
      </div>
    </div>
    <!--Right Column-->
    <div class="col30 possessions flex-wrap">
      <div class="col50">
        <div class="title label" data-i18n="loadout"></div>
        <div class="hexboxcontainer">
          <input class="hexbox" type="checkbox" name="attr_lightloadout" value="1"/><span class="hexbox">
            <div class="loadoutlabel" data-i18n="light"></div></span>
        </div>
        <div class="hexboxcontainer">
          <input class="hexbox" type="checkbox" name="attr_mediumloadout" value="1"/><span class="hexbox">
            <div class="loadoutlabel" data-i18n="medium"></div></span>
        </div>
        <div class="hexboxcontainer">
          <input class="hexbox" type="checkbox" name="attr_heavyloadout" value="1"/><span class="hexbox">
            <div class="loadoutlabel" data-i18n="heavy"></div></span>
        </div>
        <div class="title label purselabel" data-i18n="purse"></div>
      </div>
      <div class="col50">
        <div class="title label" data-i18n="stash"></div>
      </div>
    </div>
    <div class="col33 culture"></div>
    <div class="col33 lineage"></div>
    <div class="col33 devotion"></div>
  </div>
  <div class="factionsheet flex-wrap">
    <h1>Faction Sheet</h1>
  </div>
</div>
<!--Mail Roll Template-->
<!--roll_name is the name of the thing being roll-->
<!--name is the name of the character doing the rolling-->
<!--stat_name is the name of the stat added to the roll-->
<!--result is the die roll-->
<rolltemplate class="sheet-rolltemplate-mp">
  <table>
    <tr>
      <th colspan="2">{{roll_name}}</th>
    </tr>
    <tr> 
      <td colspan="2">{{name}} rolled {{#stat_name}} {{stat_name}}{{/stat_name}}{{#roll_mod}}({{roll_mod}}){{/roll_mod}}</td>
    </tr>
    <tr>{{#rollGreater() result 9}}
      <td class="result success">{{result}}</td>
      <td>Success!</td>{{/rollGreater() result 9}}
      {{#rollBetween() result 7 9}}
      <td class="result">{{result}}</td>
      <td>Partial Success</td>{{/rollBetween() result 7 9}}
      {{#rollLess() result 7}}
      <td class="result failure">{{result}}</td>
      <td>Miss</td>{{/rollLess() result 7}}
    </tr>
  </table>
</rolltemplate>
<script type="text/worker">
"use strict";
const data = {
	"cultures":{
	},
	"lineages":{
	},
	"devotions:":{
	}
};
const sheetVersion = "0.1";
const sheetName = "Sig: City of Blades";
//Translation of data
const getTranslation = (key) => (getTranslationByKey(key) || "NO_TRANSLATION_FOUND");
/* Utility functions - shouldn't need to touch most of these */
//Completely lifted from joesinghaus
//There are probably many that I don't need ¯\_(ツ)_/¯
const mySetAttrs = (attrs, options, callback) => {
	const finalAttrs = Object.keys(attrs).reduce((m, k) => {
		m[k] = String(attrs[k]);
		return m;
	}, {});
	console.log(finalAttrs);
	setAttrs(finalAttrs, options, callback);
},
setAttr = (name, value) => {
	getAttrs([name], v => {
		const setting = {};
		if (v[name] !== String(value)) setting[name] = String(value);
		setAttrs(setting);
	});
},
fillRepeatingSectionFromData = (sectionName, dataList, autogen, callback) => {
	callback = callback || (() => {});
	getSectionIDs(`repeating_${sectionName}`, idList => {
		const existingRowAttributes = [
			...idList.map(id => `repeating_${sectionName}_${id}_name`),
			...idList.map(id => `repeating_${sectionName}_${id}_autogen`)
		];
		getAttrs(existingRowAttributes, v => {
			/* Delete auto-generated rows */
			if (autogen) {
				idList = idList.filter(id => {
					if (v[`repeating_${sectionName}_${id}_autogen`]) {
						removeRepeatingRow(`repeating_${sectionName}_${id}`);
						return false;
					}
					else return true;
				});
			}
			const existingRowNames = idList.map(id => v[`repeating_${sectionName}_${id}_name`]),
				createdIDs = [],
				setting = dataList.filter(o => !existingRowNames.includes(o.name))
					.map(o => {
						let rowID;
						while (!rowID) {
							let newID = generateRowID();
							if (!createdIDs.includes(newID)) {
								rowID = newID;
								createdIDs.push(rowID);
							}
						}
						const newAttrs = {};
						if (autogen) {
							newAttrs[`repeating_${sectionName}_${rowID}_autogen`] = "1";
						}
						return Object.keys(o).reduce((m, key) => {
							m[`repeating_${sectionName}_${rowID}_${key}`] = o[key];
							return m;
						}, newAttrs);
					})
					.reduce((m, o) => Object.assign(m, o), {});
			mySetAttrs(setting, {}, callback);
		});
	});
},
diceMagic = num => {
	const range = end => [...Array(end + 1).keys()].slice(1);
	if (num > 0) return `dice=${range(num).map(() => "[[d6]]").join("&"+"#44"+"; ")}`;
	else return "zerodice=[[d6]]&"+"#44"+"; [[d6]]";
},
buildRollFormula = base => {
	return ` {{?{@{bonusdice}|${
		[0, 1, 2, 3, 4, 5, 6, -1, -2, -3].map(n => `${n},${diceMagic(n + (parseInt(base) || 0))}`).join("|")
	}}}}`;
},
buildNumdiceFormula = () => {
	return ` {{?{${getTranslation("numberofdice")}|${
		[0, 1, 2, 3, 4, 5, 6].map(n => `${n},${diceMagic(n)}`).join("|")
	}}}}`;
},
emptyFirstRowIfUnnamed = sectionName => {
	getSectionIDs(`repeating_${sectionName}`, idList => {
		const id = idList[0];
		getAttrs([`repeating_${sectionName}_${id}_name`], v => {
			if (!v[`repeating_${sectionName}_${id}_name`]) {
				removeRepeatingRow(`repeating_${sectionName}_${id}`);
			}
		});
	});
},
handleBoxesFill = (name, upToFour) => {
	on(`change:${name}1 change:${name}2 change:${name}3 change:${name}4`, event => {
		if (event.sourceType !== "player") return;
		getAttrs([event.sourceAttribute], v => {
			const rName = event.sourceAttribute.slice(0, -1),
				setting = {};
			if (String(v[event.sourceAttribute]) === "1") {
				switch (event.sourceAttribute.slice(-1)) {
				case "4":
					setting[`${rName}3`] = 1;
					/* falls through */
				case "3":
					setting[`${rName}2`] = 1;
					/* falls through */
				case "2":
					setting[`${rName}1`] = 1;
				}
			}
			if (String(v[event.sourceAttribute]) === "0") {
				switch (event.sourceAttribute.slice(-1)) {
				case "1":
					setting[`${rName}2`] = 0;
					/* falls through */
				case "2":
					setting[`${rName}3`] = 0;
					/* falls through */
				case "3":
					if (upToFour) setting[`${rName}4`] = 0;
				}
			}
			mySetAttrs(setting);
		});
	});
};
//Functions for actions happening in the sheet
on("change:freebooterorfaction", event => {
	getAttrs(["freebooterorfaction", "change_attributes"], v => {
		console.log(v.freebooterorfaction);
		if(v.freebooterorfaction == "Freebooter Sheet"){
			setAttr("sheettype", 1);
		} else if (v.freebooterorfaction == "Faction Sheet"){
			setAttr("sheettype", 2);
		}
	});
});
</script>
